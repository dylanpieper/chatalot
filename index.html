<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Batch Processing for Chat Models • hellmer</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Batch Processing for Chat Models">
<meta name="description" content="Batch processing framework for ellmer chat model interactions. Enables sequential and parallel processing of chat completions. Core capabilities include error handling with backoff, state persistence, progress tracking, and retry management. Parallel processing is implemented via the future framework. Additional features include structured data extraction, tool integration, timeout handling, verbosity control, and sound notifications. Includes methods for returning chat texts, chat objects, progress status, and structured data.">
<meta property="og:description" content="Batch processing framework for ellmer chat model interactions. Enables sequential and parallel processing of chat completions. Core capabilities include error handling with backoff, state persistence, progress tracking, and retry management. Parallel processing is implemented via the future framework. Additional features include structured data extraction, tool integration, timeout handling, verbosity control, and sound notifications. Includes methods for returning chat texts, chat objects, progress status, and structured data.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">hellmer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/using-chat-models.html">Using Ellmer Chat Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dylanpieper/hellmer" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="hellmer-">hellmer <img src="reference/figures/hellmer-hex.png" align="right" width="140"><a class="anchor" aria-label="anchor" href="#hellmer-"></a>
</h1></div>
<p>hellmer enables sequential or parallel batch processing for <a href="https://ellmer.tidyverse.org/reference/index.html" class="external-link">chat models</a> from <a href="https://github.com/tidyverse/ellmer" class="external-link">ellmer</a>.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Process multiple chat interactions with:</p>
<ul>
<li>
<a href="https://ellmer.tidyverse.org/articles/tool-calling.html" class="external-link">Tooling</a> and <a href="https://ellmer.tidyverse.org/articles/structured-data.html" class="external-link">structured data extraction</a>
</li>
<li>State persistence and recovery</li>
<li>Progress tracking</li>
<li>Configurable output verbosity</li>
<li>Automatic retry with backoff</li>
<li>Timeout handling</li>
<li>Sound notifications</li>
</ul>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"dylanpieper/hellmer"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-package">Load Package<a class="anchor" aria-label="anchor" href="#load-package"></a>
</h2>
<p>Run <code><a href="https://dylanpieper.github.io/hellmer/">library(hellmer)</a></code> to load the package and attach <code>ellmer</code> for easy access to the chat models.</p>
<p>To finish the instructions on setting an API key, I’ll provide both the RStudio approach you started and the alternative methods:</p>
</div>
<div class="section level2">
<h2 id="set-api-key">Set API Key<a class="anchor" aria-label="anchor" href="#set-api-key"></a>
</h2>
<p>I recommend the <code>usethis</code> package to add API keys to your <code>.Renviron</code> such as <code>OPENAI_API_KEY=your-key</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">edit_r_environ</span><span class="op">(</span>scope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"user"</span>, <span class="st">"project"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic Usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<div class="section level3">
<h3 id="sequential-processing">Sequential Processing<a class="anchor" aria-label="anchor" href="#sequential-processing"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_sequential.html">chat_sequential</a></span><span class="op">(</span><span class="va">chat_openai</span>, </span>
<span>                        system_prompt <span class="op">=</span> <span class="st">"Reply concisely, one sentence"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prompts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"What is R?"</span>,</span>
<span>  <span class="st">"Explain base R versus tidyverse"</span>,</span>
<span>  <span class="st">"Explain vectors, lists, and data frames"</span>,</span>
<span>  <span class="st">"How do environments work in R?"</span>,</span>
<span>  <span class="st">"Compare R and Python for data analysis"</span>,</span>
<span>  <span class="st">"Explain lazy evaluation in R"</span>,</span>
<span>  <span class="st">"What are R's apply functions?"</span>,</span>
<span>  <span class="st">"How do R packages work?"</span>,</span>
<span>  <span class="st">"Explain R's object-oriented programming systems."</span>,</span>
<span>  <span class="st">"What are closures in R?"</span>,</span>
<span>  <span class="st">"Describe R memory management"</span>,</span>
<span>  <span class="st">"How does R handle missing values?"</span>,</span>
<span>  <span class="st">"Explain R's integration with C++"</span>,</span>
<span>  <span class="st">"Compare dplyr and data.table approaches"</span>,</span>
<span>  <span class="st">"What are R formulas and when to use them?"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">prompts</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span><span class="op">$</span><span class="fu">progress</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="fu">texts</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="fu">chats</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallel-processing">Parallel Processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_future.html">chat_future</a></span><span class="op">(</span><span class="va">chat_openai</span>, </span>
<span>                    system_prompt <span class="op">=</span> <span class="st">"Reply concisely, one sentence"</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="performance-vs-safety-trade-off">Performance vs Safety Trade-Off<a class="anchor" aria-label="anchor" href="#performance-vs-safety-trade-off"></a>
</h4>
<p>When using parallel processing with <code>chat_future</code>, there’s a trade-off between performance and safety:</p>
<ul>
<li>
<strong>Maximum Performance</strong>: Setting <code>chunk_size</code> equal to the number of prompts results in a 4-5x faster processing speed</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">prompts</span>, chunk_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">prompts</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>
<strong>Maximum Safety</strong>: Using a smaller <code>chunk_size</code> ensures state is saved more frequently, allowing recovery if something goes wrong (default: number of prompts / 10)</li>
</ul>
</div>
<div class="section level4">
<h4 id="naming-note">Naming Note<a class="anchor" aria-label="anchor" href="#naming-note"></a>
</h4>
<p><code>chat_future</code> isn’t named <code>chat_parallel</code> because the latter will be included in <code>ellmer</code> (<a href="https://github.com/tidyverse/ellmer/issues/143" class="external-link">#143</a>).</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="features">Features<a class="anchor" aria-label="anchor" href="#features"></a>
</h2>
<div class="section level3">
<h3 id="tooling">Tooling<a class="anchor" aria-label="anchor" href="#tooling"></a>
</h3>
<p>Register and use tools/function calling:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">square_number</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">num</span><span class="op">)</span> <span class="va">num</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu">tool</span><span class="op">(</span></span>
<span>  <span class="va">square_number</span>,</span>
<span>  <span class="st">"Calculates the square of a given number"</span>,</span>
<span>  num <span class="op">=</span> <span class="fu">type_integer</span><span class="op">(</span><span class="st">"The number to square"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prompts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"What is the square of 3?"</span>,</span>
<span>  <span class="st">"Calculate the square of 5."</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="structured-data-extraction">Structured Data Extraction<a class="anchor" aria-label="anchor" href="#structured-data-extraction"></a>
</h3>
<p>Extract structured data using type specifications:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">type_sentiment</span> <span class="op">&lt;-</span> <span class="fu">type_object</span><span class="op">(</span></span>
<span>  <span class="st">"Extract sentiment scores"</span>,</span>
<span>  positive_score <span class="op">=</span> <span class="fu">type_number</span><span class="op">(</span><span class="st">"Positive sentiment score, 0.0 to 1.0"</span><span class="op">)</span>,</span>
<span>  negative_score <span class="op">=</span> <span class="fu">type_number</span><span class="op">(</span><span class="st">"Negative sentiment score, 0.0 to 1.0"</span><span class="op">)</span>,</span>
<span>  neutral_score <span class="op">=</span> <span class="fu">type_number</span><span class="op">(</span><span class="st">"Neutral sentiment score, 0.0 to 1.0"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">prompts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"I love this product! It's amazing!"</span>,</span>
<span>  <span class="st">"This is okay, nothing special."</span>,</span>
<span>  <span class="st">"Terrible experience, very disappointed."</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">prompts</span>, type_spec <span class="op">=</span> <span class="va">type_sentiment</span><span class="op">)</span></span>
<span><span class="va">structured_data</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="fu">structured_data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="state-management">State Management<a class="anchor" aria-label="anchor" href="#state-management"></a>
</h3>
<p>Batch processing automatically saves state and can resume interrupted operations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">chat</span><span class="op">$</span><span class="fu">batch</span><span class="op">(</span><span class="va">prompts</span>, state_path <span class="op">=</span> <span class="st">"chat_state.rds"</span><span class="op">)</span></span></code></pre></div>
<p>If <code>state_path</code> is not defined, a temporary file will be created by default.</p>
</div>
<div class="section level3">
<h3 id="output-control">Output Control<a class="anchor" aria-label="anchor" href="#output-control"></a>
</h3>
<p>Control verbosity with the <code>echo</code> parameter (sequential only):</p>
<ul>
<li>
<code>"none"</code>: Silent operation with progress bar</li>
<li>
<code>"text"</code>: Show chat responses only</li>
<li>
<code>"all"</code>: Show both prompts and responses</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_sequential.html">chat_sequential</a></span><span class="op">(</span></span>
<span>  <span class="va">chat_openai</span>, </span>
<span>  echo <span class="op">=</span> <span class="st">"none"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="automatic-retry">Automatic Retry<a class="anchor" aria-label="anchor" href="#automatic-retry"></a>
</h3>
<p>Automatically retry failed requests with backoff, which serves as a wide guardrail against errors while <code>ellmer</code> and <code>httr2</code> serve as a narrow guardrail against specific API limits:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_sequential.html">chat_sequential</a></span><span class="op">(</span></span>
<span>  <span class="va">chat_openai</span>,         <span class="co"># Ellmer chat model</span></span>
<span>  max_retries <span class="op">=</span> <span class="fl">3</span>,     <span class="co"># Maximum retry attempts</span></span>
<span>  initial_delay <span class="op">=</span> <span class="fl">20</span>,  <span class="co"># Initial delay in seconds</span></span>
<span>  max_delay <span class="op">=</span> <span class="fl">60</span>,      <span class="co"># Maximum delay between retries</span></span>
<span>  backoff_factor <span class="op">=</span> <span class="fl">2</span>   <span class="co"># Multiply delay by this factor after each retry</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If a request fails, the code will:</p>
<ol style="list-style-type: decimal">
<li>Wait for the <code>initial_delay</code>
</li>
<li>Retry the request</li>
<li>If it fails again, wait for (delay × <code>backoff_factor</code>)</li>
<li>Continue until success or <code>max_retries</code> is reached</li>
</ol>
<p>If the code detects an authorization or API key issue, it will stop immediately.</p>
</div>
<div class="section level3">
<h3 id="timeout-handling">Timeout Handling<a class="anchor" aria-label="anchor" href="#timeout-handling"></a>
</h3>
<p>The timeout parameter specifies the maximum time to wait for a response from the chat model for each prompt. However, this parameter is still limited by the timeouts propagated up from the chat model functions.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_future</span>(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  chat_openai,</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="at">system_prompt =</span> <span class="st">"Reply concisely, one sentence"</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="at">timeout =</span> <span class="dv">60</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sound-notifications">Sound Notifications<a class="anchor" aria-label="anchor" href="#sound-notifications"></a>
</h3>
<p>Toggle sound notifications on batch completion, interruption, and error:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_sequential.html">chat_sequential</a></span><span class="op">(</span></span>
<span>  <span class="va">chat_openai</span>,</span>
<span>  beep <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="results-methods">Results Methods<a class="anchor" aria-label="anchor" href="#results-methods"></a>
</h3>
<ul>
<li>
<code><a href="reference/texts.html">texts()</a></code>: Returns response texts in the same format as the input prompts (i.e., a list if prompts were provided as a list, or a character vector if prompts were provided as a vector)</li>
<li>
<code><a href="reference/chats.html">chats()</a></code>: Returns a list of chat objects</li>
<li>
<code><a href="reference/progress.html">progress()</a></code>: Returns processing statistics</li>
<li>
<code><a href="reference/structured_data.html">structured_data()</a></code>: Returns extracted structured data (if <code>type_spec</code> is provided)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li>
<a href="https://dylanpieper.github.io/hellmer/articles/using-chat-models.html">Using Ellmer Chat Models</a>: Are you wondering if you can use <code>chat_openai()</code> as a user-defined object instead of the <code>chat_openai</code> function? Of course you can! Learn more about the two methods and the default interface.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/dylanpieper/hellmer" class="external-link">Browse source code</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing hellmer</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Dylan Pieper <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dylan Pieper.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
